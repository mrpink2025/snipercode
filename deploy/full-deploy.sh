#!/bin/bash

################################################################################
#
# CORPMONITOR - SCRIPT DE DEPLOY COMPLETO
# 
# Atualiza servidor Ubuntu 24.04 com:
# - Git pull do c√≥digo
# - Build do frontend (React/Vite)
# - Build da extens√£o Chrome (.crx assinado)
# - Deploy dos arquivos
# - Configura√ß√£o Nginx
# - Valida√ß√£o completa
#
# Uso: sudo ./deploy/full-deploy.sh
#
################################################################################

set -euo pipefail

# ============================================================================
# CONFIGURA√á√ïES
# ============================================================================

PROJECT_ROOT="/var/www/monitor-corporativo"
EXTENSION_DIR="$PROJECT_ROOT/chrome-extension"
EXTENSION_DEPLOY_DIR="$PROJECT_ROOT/extension"
BACKUP_DIR="/var/backups/monitor-corporativo"
LOG_DIR="/var/log"
NGINX_CONFIG="/etc/nginx/sites-available/monitor-corporativo"
DOMAIN="monitorcorporativo.com"

TIMESTAMP=$(date +%Y%m%d_%H%M%S)
LOG_FILE="$LOG_DIR/corpmonitor-deploy-${TIMESTAMP}.log"
REPORT_FILE="$PROJECT_ROOT/DEPLOYMENT_REPORT_${TIMESTAMP}.txt"

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# ============================================================================
# FUN√á√ïES AUXILIARES
# ============================================================================

log_info() {
    echo -e "${CYAN}[$(date +'%H:%M:%S')]${NC} $1" | tee -a "$LOG_FILE"
}

log_success() {
    echo -e "${GREEN}‚úì${NC} $1" | tee -a "$LOG_FILE"
}

log_error() {
    echo -e "${RED}‚úó${NC} $1" | tee -a "$LOG_FILE"
}

log_warning() {
    echo -e "${YELLOW}‚ö†${NC} $1" | tee -a "$LOG_FILE"
}

log_phase() {
    echo -e "\n${BOLD}${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}" | tee -a "$LOG_FILE"
    echo -e "${BOLD}${BLUE}[FASE $1/10]${NC} $2" | tee -a "$LOG_FILE"
    echo -e "${BOLD}${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}" | tee -a "$LOG_FILE"
}

rollback() {
    log_error "ERRO CR√çTICO! Iniciando rollback..."
    
    if [ -f "$BACKUP_DIR/backup-${TIMESTAMP}.tar.gz" ]; then
        log_info "Restaurando c√≥digo do backup..."
        cd "$PROJECT_ROOT"
        tar -xzf "$BACKUP_DIR/backup-${TIMESTAMP}.tar.gz" --strip-components=1
        log_success "C√≥digo restaurado"
    fi
    
    if [ -f "$NGINX_CONFIG.backup-${TIMESTAMP}" ]; then
        log_info "Restaurando configura√ß√£o Nginx..."
        cp "$NGINX_CONFIG.backup-${TIMESTAMP}" "$NGINX_CONFIG"
        nginx -t && systemctl reload nginx
        log_success "Nginx restaurado"
    fi
    
    log_error "Rollback conclu√≠do. Verifique os logs em: $LOG_FILE"
    exit 1
}

# ============================================================================
# BANNER INICIAL
# ============================================================================

clear
echo -e "${BOLD}${CYAN}"
cat << "EOF"
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  üöÄ DEPLOY COMPLETO - CORPMONITOR üöÄ
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
EOF
echo -e "${NC}"

echo -e "Este script vai:"
echo -e "  ${GREEN}1.${NC} Atualizar c√≥digo (git pull)"
echo -e "  ${GREEN}2.${NC} Recompilar frontend (React/Vite)"
echo -e "  ${GREEN}3.${NC} Recompilar extens√£o Chrome (.crx assinado)"
echo -e "  ${GREEN}4.${NC} Deploy no servidor (/extension/)"
echo -e "  ${GREEN}5.${NC} Configurar/atualizar Nginx"
echo -e "  ${GREEN}6.${NC} Validar todas as URLs"
echo ""
echo -e "${YELLOW}Backup autom√°tico ser√° criado em:${NC}"
echo -e "  $BACKUP_DIR/backup-${TIMESTAMP}.tar.gz"
echo ""
echo -e "${YELLOW}Log ser√° salvo em:${NC}"
echo -e "  $LOG_FILE"
echo ""

read -p "Deseja continuar? (s/n): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Ss]$ ]]; then
    echo "Deploy cancelado pelo usu√°rio."
    exit 0
fi

# Iniciar log
echo "Deploy iniciado em: $(date)" > "$LOG_FILE"

# ============================================================================
# FASE 1: VERIFICA√á√ïES INICIAIS
# ============================================================================

log_phase 1 "Verifica√ß√µes Iniciais"

# Verificar root
if [ "$EUID" -ne 0 ]; then
    log_error "Este script precisa ser executado como root (sudo)"
    exit 1
fi
log_success "Executando como root"

# Verificar se o projeto existe ou precisa clonar
if [ ! -d "$PROJECT_ROOT" ] || [ ! -d "$PROJECT_ROOT/.git" ]; then
    log_warning "Reposit√≥rio n√£o existe, clonando do GitHub..."
    
    mkdir -p "$(dirname $PROJECT_ROOT)"
    if git clone https://github.com/mrpink2025/snipercode.git "$PROJECT_ROOT" >> "$LOG_FILE" 2>&1; then
        log_success "Reposit√≥rio clonado com sucesso"
    else
        log_error "Falha ao clonar reposit√≥rio do GitHub"
        log_error "Verifique se:"
        log_error "  1. O reposit√≥rio existe"
        log_error "  2. Voc√™ tem permiss√£o de acesso"
        log_error "  3. Credenciais est√£o configuradas (se privado)"
        exit 1
    fi
fi
log_success "Diret√≥rio do projeto encontrado"

# Verificar Git
if ! command -v git &> /dev/null; then
    log_error "Git n√£o est√° instalado"
    exit 1
fi
log_success "Git instalado: $(git --version)"

# Verificar Node.js
if ! command -v node &> /dev/null; then
    log_error "Node.js n√£o est√° instalado"
    exit 1
fi
log_success "Node.js instalado: $(node --version)"

# Verificar npm
if ! command -v npm &> /dev/null; then
    log_error "npm n√£o est√° instalado"
    exit 1
fi
log_success "npm instalado: $(npm --version)"

# Verificar Nginx
if ! command -v nginx &> /dev/null; then
    log_error "Nginx n√£o est√° instalado"
    exit 1
fi
log_success "Nginx instalado: $(nginx -v 2>&1)"

# Verificar se √© reposit√≥rio Git
cd "$PROJECT_ROOT"
if [ ! -d ".git" ]; then
    log_error "N√£o √© um reposit√≥rio Git"
    exit 1
fi
log_success "Reposit√≥rio Git v√°lido"

# Verificar e corrigir remote do GitHub
log_info "Verificando configura√ß√£o do GitHub..."
GITHUB_REMOTE=$(git remote get-url origin 2>/dev/null || echo "")
EXPECTED_REMOTE="https://github.com/mrpink2025/snipercode.git"

if [ "$GITHUB_REMOTE" != "$EXPECTED_REMOTE" ]; then
    log_warning "Remote n√£o aponta para o GitHub correto"
    log_info "Remote atual: ${GITHUB_REMOTE:-<n√£o configurado>}"
    log_info "Configurando remote correto..."
    
    if [ -z "$GITHUB_REMOTE" ]; then
        git remote add origin "$EXPECTED_REMOTE" >> "$LOG_FILE" 2>&1
    else
        git remote set-url origin "$EXPECTED_REMOTE" >> "$LOG_FILE" 2>&1
    fi
    
    log_success "Remote configurado: $EXPECTED_REMOTE"
else
    log_success "Remote do GitHub OK"
fi

# Testar acesso ao GitHub
log_info "Testando acesso ao GitHub..."
if ! git ls-remote "$EXPECTED_REMOTE" HEAD &>/dev/null; then
    log_error "N√£o foi poss√≠vel acessar o reposit√≥rio GitHub"
    log_error "Verifique se:"
    log_error "  1. O reposit√≥rio existe: https://github.com/mrpink2025/snipercode"
    log_error "  2. Voc√™ tem permiss√£o de acesso"
    log_error "  3. Credenciais est√£o configuradas (se privado)"
    log_error ""
    log_error "Para reposit√≥rio privado, configure autentica√ß√£o:"
    log_error "  Token: git config --global credential.helper store"
    log_error "  SSH: ssh-keygen + adicionar chave no GitHub"
    exit 1
fi
log_success "Acesso ao GitHub validado"

log_success "Todas as verifica√ß√µes passaram"

# ============================================================================
# FASE 2: BACKUP COMPLETO
# ============================================================================

log_phase 2 "Criando Backup"

mkdir -p "$BACKUP_DIR"

# Backup do c√≥digo (exceto node_modules, .git, backups)
log_info "Criando backup do c√≥digo..."
BACKUP_FILE="$BACKUP_DIR/backup-${TIMESTAMP}.tar.gz"

tar -czf "$BACKUP_FILE" \
    --exclude='node_modules' \
    --exclude='.git' \
    --exclude='backups' \
    --exclude='dist' \
    --exclude='chrome-extension/dist' \
    -C "$(dirname $PROJECT_ROOT)" \
    "$(basename $PROJECT_ROOT)" 2>> "$LOG_FILE"

BACKUP_SIZE=$(du -h "$BACKUP_FILE" | cut -f1)
log_success "Backup criado: $BACKUP_FILE ($BACKUP_SIZE)"

# Backup da configura√ß√£o Nginx
if [ -f "$NGINX_CONFIG" ]; then
    cp "$NGINX_CONFIG" "$NGINX_CONFIG.backup-${TIMESTAMP}"
    log_success "Backup Nginx criado"
fi

# Salvar commit atual para refer√™ncia
CURRENT_COMMIT=$(git rev-parse HEAD)
echo "$CURRENT_COMMIT" > "$BACKUP_DIR/commit-${TIMESTAMP}.txt"
log_info "Commit atual: ${CURRENT_COMMIT:0:8}"

# ============================================================================
# FASE 3: ATUALIZAR C√ìDIGO (GIT PULL)
# ============================================================================

log_phase 3 "Atualizando C√≥digo"

cd "$PROJECT_ROOT"

# Guardar mudan√ßas locais (se houver)
if ! git diff-index --quiet HEAD --; then
    log_warning "H√° mudan√ßas locais n√£o commitadas"
    git stash save "Auto-stash before deploy ${TIMESTAMP}" >> "$LOG_FILE" 2>&1
    log_info "Mudan√ßas guardadas no stash"
fi

# Detectar branch padr√£o do remote
log_info "Detectando branch padr√£o..."
git fetch origin >> "$LOG_FILE" 2>&1

DEFAULT_BRANCH=$(git remote show origin 2>/dev/null | grep 'HEAD branch' | cut -d' ' -f5)
if [ -z "$DEFAULT_BRANCH" ]; then
    # Fallback: tentar detectar a branch atual
    DEFAULT_BRANCH=$(git branch --show-current)
    if [ -z "$DEFAULT_BRANCH" ]; then
        DEFAULT_BRANCH="main"
        log_warning "N√£o foi poss√≠vel detectar branch, usando 'main'"
    else
        log_info "Usando branch atual: $DEFAULT_BRANCH"
    fi
else
    log_success "Branch remota detectada: $DEFAULT_BRANCH"
fi

# Verificar se h√° atualiza√ß√µes
LOCAL=$(git rev-parse @)
REMOTE=$(git rev-parse origin/$DEFAULT_BRANCH 2>/dev/null || git rev-parse @{u})

if [ "$LOCAL" = "$REMOTE" ]; then
    log_info "C√≥digo j√° est√° atualizado"
else
    # Pull
    log_info "Atualizando c√≥digo (git pull origin $DEFAULT_BRANCH)..."
    if ! git pull origin "$DEFAULT_BRANCH" >> "$LOG_FILE" 2>&1; then
        log_error "Falha no git pull"
        rollback
    fi
    
    # Mostrar novos commits
    NEW_COMMITS=$(git log --oneline "$LOCAL".."$REMOTE" | wc -l)
    log_success "C√≥digo atualizado ($NEW_COMMITS novos commits)"
    
    git log --oneline -3 | tee -a "$LOG_FILE"
fi

# ============================================================================
# FASE 4: ATUALIZAR DEPEND√äNCIAS
# ============================================================================

log_phase 4 "Atualizando Depend√™ncias"

cd "$PROJECT_ROOT"

# Verificar se package.json mudou
if git diff --name-only "$CURRENT_COMMIT" HEAD | grep -q "package.json"; then
    log_info "package.json foi modificado, atualizando depend√™ncias..."
    
    npm install --legacy-peer-deps >> "$LOG_FILE" 2>&1
    log_success "Depend√™ncias do root atualizadas"
else
    log_info "package.json n√£o mudou, pulando atualiza√ß√£o"
fi

# Verificar depend√™ncias da extens√£o
if [ -f "$EXTENSION_DIR/package.json" ]; then
    cd "$EXTENSION_DIR"
    
    if ! [ -d "node_modules" ]; then
        log_info "Instalando depend√™ncias da extens√£o..."
        npm install >> "$LOG_FILE" 2>&1
        log_success "Depend√™ncias da extens√£o instaladas"
    elif git diff --name-only "$CURRENT_COMMIT" HEAD | grep -q "chrome-extension/package.json"; then
        log_info "package.json da extens√£o mudou, atualizando..."
        npm install >> "$LOG_FILE" 2>&1
        log_success "Depend√™ncias da extens√£o atualizadas"
    else
        log_info "Depend√™ncias da extens√£o OK"
    fi
fi

# ============================================================================
# FASE 5: COMPILAR FRONTEND
# ============================================================================

log_phase 5 "Compilando Frontend (React/Vite)"

cd "$PROJECT_ROOT"

# Remover build anterior
if [ -d "dist" ]; then
    rm -rf dist
    log_info "Build anterior removido"
fi

# Build
log_info "Executando npm run build..."
if ! npm run build >> "$LOG_FILE" 2>&1; then
    log_error "Falha no build do frontend"
    rollback
fi

# Validar build
if [ ! -f "dist/index.html" ]; then
    log_error "Build inv√°lido: dist/index.html n√£o encontrado"
    rollback
fi

DIST_SIZE=$(du -sh dist | cut -f1)
log_success "Frontend compilado com sucesso ($DIST_SIZE)"

# ============================================================================
# FASE 6: COMPILAR EXTENS√ÉO + CRX
# ============================================================================

log_phase 6 "Compilando Extens√£o Chrome"

cd "$EXTENSION_DIR"

# Build normal (.zip)
log_info "Executando npm run build (gera .zip)..."
if ! npm run build >> "$LOG_FILE" 2>&1; then
    log_error "Falha no build da extens√£o"
    rollback
fi
log_success "Extens√£o compilada (.zip)"

# Build CRX assinado
log_info "Executando npm run build:crx (gera .crx assinado)..."
if ! npm run build:crx 2>&1 | tee -a "$LOG_FILE"; then
    log_error "Falha na gera√ß√£o do .crx"
    log_error "√öltimas 20 linhas do log:"
    tail -20 "$LOG_FILE" | sed 's/^/   /'
    log_info "Log completo em: $LOG_FILE"
    rollback
fi
log_success "CRX assinado gerado"

# Validar arquivos gerados
REQUIRED_FILES=("corpmonitor.zip" "corpmonitor.crx" "corpmonitor.sha256" "update.xml")
for file in "${REQUIRED_FILES[@]}"; do
    if [ ! -f "$file" ]; then
        log_error "Arquivo n√£o encontrado: $file"
        rollback
    fi
done

# Mostrar tamanhos
ZIP_SIZE=$(du -h corpmonitor.zip | cut -f1)
CRX_SIZE=$(du -h corpmonitor.crx | cut -f1)
log_success "Arquivos gerados:"
log_info "  - corpmonitor.zip ($ZIP_SIZE)"
log_info "  - corpmonitor.crx ($CRX_SIZE)"

# Extrair Extension ID (se dispon√≠vel)
EXTENSION_ID=""
if [ -f "extension-id.txt" ]; then
    EXTENSION_ID=$(cat extension-id.txt)
    log_success "  - Extension ID: $EXTENSION_ID"
fi

# Mostrar SHA256
SHA256_HASH=$(cat corpmonitor.sha256)
log_info "  - SHA256: ${SHA256_HASH:0:16}..."

# ============================================================================
# FASE 7: DEPLOY DOS ARQUIVOS
# ============================================================================

log_phase 7 "Deploy dos Arquivos"

# Criar diret√≥rio de deploy da extens√£o
mkdir -p "$EXTENSION_DEPLOY_DIR"
log_success "Diret√≥rio criado: $EXTENSION_DEPLOY_DIR"

# Copiar arquivos da extens√£o
log_info "Copiando arquivos da extens√£o..."
cp "$EXTENSION_DIR/corpmonitor.crx" "$EXTENSION_DEPLOY_DIR/"
cp "$EXTENSION_DIR/corpmonitor.zip" "$EXTENSION_DEPLOY_DIR/"
cp "$EXTENSION_DIR/corpmonitor.sha256" "$EXTENSION_DEPLOY_DIR/"
cp "$EXTENSION_DIR/update.xml" "$EXTENSION_DEPLOY_DIR/"
log_success "Arquivos da extens√£o copiados"

# Copiar privacy policy para dist
if [ -f "$EXTENSION_DIR/privacy-policy.html" ]; then
    cp "$EXTENSION_DIR/privacy-policy.html" "$PROJECT_ROOT/dist/"
    log_success "privacy-policy.html copiado para dist/"
fi

# Definir permiss√µes corretas
chown -R www-data:www-data "$EXTENSION_DEPLOY_DIR"
chmod -R 755 "$EXTENSION_DEPLOY_DIR"
log_success "Permiss√µes configuradas (www-data:www-data)"

# ============================================================================
# FASE 8: CONFIGURAR NGINX
# ============================================================================

log_phase 8 "Configurando Nginx"

# Verificar se location /extension/ j√° existe
if grep -q "location /extension/" "$NGINX_CONFIG"; then
    log_info "Configura√ß√£o /extension/ j√° existe no Nginx"
else
    log_info "Adicionando location /extension/ ao Nginx..."
    
    # Backup antes de modificar
    cp "$NGINX_CONFIG" "$NGINX_CONFIG.backup-pre-extension"
    
    # Adicionar location block antes do √∫ltimo }
    sed -i '/^}$/i \
    # Extension Updates Directory\
    location /extension/ {\
        alias /var/www/monitor-corporativo/extension/;\
        autoindex off;\
        \
        # CORS headers for Chrome extension updates\
        add_header Access-Control-Allow-Origin "*";\
        add_header Access-Control-Allow-Methods "GET, HEAD";\
        add_header Access-Control-Allow-Headers "Content-Type";\
        \
        # Cache for 1 hour\
        add_header Cache-Control "public, max-age=3600";\
        \
        # Security headers\
        add_header X-Content-Type-Options "nosniff";\
        \
        # Allow .crx, .xml, .zip downloads\
        types {\
            application/x-chrome-extension crx;\
            application/zip zip;\
            text/plain sha256;\
            text/xml xml;\
        }\
        \
        access_log /var/log/nginx/extension-access.log;\
    }\
' "$NGINX_CONFIG"
    
    log_success "Configura√ß√£o adicionada"
fi

# Testar configura√ß√£o Nginx
log_info "Testando configura√ß√£o Nginx..."
if ! nginx -t >> "$LOG_FILE" 2>&1; then
    log_error "Configura√ß√£o Nginx inv√°lida"
    
    # Restaurar backup
    if [ -f "$NGINX_CONFIG.backup-pre-extension" ]; then
        cp "$NGINX_CONFIG.backup-pre-extension" "$NGINX_CONFIG"
        log_info "Configura√ß√£o restaurada"
    fi
    
    rollback
fi
log_success "Configura√ß√£o Nginx v√°lida"

# Recarregar Nginx (zero downtime)
log_info "Recarregando Nginx..."
if ! systemctl reload nginx >> "$LOG_FILE" 2>&1; then
    log_error "Falha ao recarregar Nginx"
    rollback
fi
log_success "Nginx recarregado com sucesso"

# ============================================================================
# FASE 9: VALIDA√á√ÉO AUTOM√ÅTICA
# ============================================================================

log_phase 9 "Valida√ß√£o Autom√°tica"

TESTS_PASSED=0
TESTS_TOTAL=6

# Aguardar Nginx estabilizar
sleep 2

# Teste 1: Site principal
log_info "Testando site principal..."
if curl -sS -o /dev/null -w "%{http_code}" "http://$DOMAIN" | grep -q "200\|301\|302"; then
    log_success "‚úì Site principal OK"
    ((TESTS_PASSED++))
else
    log_error "‚úó Site principal FALHOU"
fi

# Teste 2: Privacy Policy
log_info "Testando privacy policy..."
if curl -sS -o /dev/null -w "%{http_code}" "http://$DOMAIN/privacy-policy.html" | grep -q "200"; then
    log_success "‚úì Privacy policy OK"
    ((TESTS_PASSED++))
else
    log_warning "‚úó Privacy policy n√£o acess√≠vel"
fi

# Teste 3: CRX
log_info "Testando download do .crx..."
if curl -sS -o /dev/null -w "%{http_code}" "http://$DOMAIN/extension/corpmonitor.crx" | grep -q "200"; then
    log_success "‚úì CRX acess√≠vel"
    ((TESTS_PASSED++))
else
    log_error "‚úó CRX n√£o acess√≠vel"
fi

# Teste 4: update.xml
log_info "Testando update.xml..."
if curl -sS -o /dev/null -w "%{http_code}" "http://$DOMAIN/extension/update.xml" | grep -q "200"; then
    log_success "‚úì update.xml acess√≠vel"
    ((TESTS_PASSED++))
else
    log_error "‚úó update.xml n√£o acess√≠vel"
fi

# Teste 5: SHA256
log_info "Testando corpmonitor.sha256..."
if curl -sS -o /dev/null -w "%{http_code}" "http://$DOMAIN/extension/corpmonitor.sha256" | grep -q "200"; then
    log_success "‚úì SHA256 acess√≠vel"
    ((TESTS_PASSED++))
else
    log_warning "‚úó SHA256 n√£o acess√≠vel"
fi

# Teste 6: Processos Nginx
log_info "Verificando processos Nginx..."
if pgrep nginx > /dev/null; then
    NGINX_PROCESSES=$(pgrep nginx | wc -l)
    log_success "‚úì Nginx rodando ($NGINX_PROCESSES processos)"
    ((TESTS_PASSED++))
else
    log_error "‚úó Nginx n√£o est√° rodando"
fi

# Resultado da valida√ß√£o
echo ""
if [ $TESTS_PASSED -eq $TESTS_TOTAL ]; then
    log_success "Valida√ß√£o completa: $TESTS_PASSED/$TESTS_TOTAL testes passaram ‚úì"
else
    log_warning "Valida√ß√£o parcial: $TESTS_PASSED/$TESTS_TOTAL testes passaram"
fi

# ============================================================================
# FASE 10: GERAR RELAT√ìRIO
# ============================================================================

log_phase 10 "Gerando Relat√≥rio"

cat > "$REPORT_FILE" << EOF
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  RELAT√ìRIO DE DEPLOY - CORPMONITOR
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Data/Hora: $(date)
Servidor: $(hostname)
Usu√°rio: $(whoami)

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  STATUS DO DEPLOY
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

‚úì C√≥digo atualizado via Git
‚úì Frontend compilado (React/Vite)
‚úì Extens√£o compilada (.zip + .crx assinado)
‚úì Arquivos copiados para $EXTENSION_DEPLOY_DIR
‚úì Nginx configurado e recarregado
‚úì Valida√ß√£o: $TESTS_PASSED/$TESTS_TOTAL testes passaram

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  URLs P√öBLICAS
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Site Principal:     http://$DOMAIN
Privacy Policy:     http://$DOMAIN/privacy-policy.html

Extens√£o CRX:       http://$DOMAIN/extension/corpmonitor.crx
Extens√£o ZIP:       http://$DOMAIN/extension/corpmonitor.zip
Update XML:         http://$DOMAIN/extension/update.xml
SHA256 Checksum:    http://$DOMAIN/extension/corpmonitor.sha256

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  INFORMA√á√ïES DA EXTENS√ÉO
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Extension ID:       ${EXTENSION_ID:-"(n√£o extra√≠do)"}
SHA256 Hash:        $SHA256_HASH

IMPORTANTE: Use estes valores em:
  1. corpmonitor-installer/source/wix/Registry.wxs
     Substitua [PREENCHER_EXTENSION_ID] por: $EXTENSION_ID
  
  2. corpmonitor-installer/source/wix/Product.wxs
     Adicione: <?define ExtensionId = "$EXTENSION_ID" ?>

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  ARQUIVOS LOCAIS
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Frontend:           $PROJECT_ROOT/dist/
Extens√£o (build):   $EXTENSION_DIR/corpmonitor.{zip,crx}
Extens√£o (deploy):  $EXTENSION_DEPLOY_DIR/
Backup:             $BACKUP_FILE
Log:                $LOG_FILE

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  PR√ìXIMOS PASSOS
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

1. Atualizar placeholders no MSI:
   - Abra Registry.wxs e substitua [PREENCHER_EXTENSION_ID]
   - Abra Product.wxs e adicione <?define ExtensionId = "..." ?>

2. Recompilar o MSI (no Windows):
   cd corpmonitor-installer
   .\build-msi.ps1 -Clean

3. Testar instala√ß√£o:
   - Instale o MSI em m√°quina de teste
   - Verifique chrome://extensions/
   - Verifique chrome://policy/

4. Deploy via GPO:
   - Copie CorpMonitor.msi para SYSVOL
   - Crie GPO de instala√ß√£o de software

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  ROLLBACK (SE NECESS√ÅRIO)
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Para reverter este deploy:

1. Restaurar c√≥digo:
   cd $PROJECT_ROOT
   sudo tar -xzf $BACKUP_FILE --strip-components=1

2. Restaurar Nginx:
   sudo cp $NGINX_CONFIG.backup-${TIMESTAMP} $NGINX_CONFIG
   sudo nginx -t && sudo systemctl reload nginx

3. Verificar:
   sudo systemctl status nginx
   curl -I http://$DOMAIN

Commit do backup: $CURRENT_COMMIT

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
EOF

log_success "Relat√≥rio gerado: $REPORT_FILE"

# ============================================================================
# RESUMO FINAL
# ============================================================================

echo ""
echo -e "${BOLD}${GREEN}"
cat << "EOF"
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  ‚úÖ DEPLOY CONCLU√çDO COM SUCESSO!
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
EOF
echo -e "${NC}"

echo -e "${CYAN}üìã URLs P√∫blicas:${NC}"
echo -e "   ${BOLD}Site:${NC}      http://$DOMAIN"
echo -e "   ${BOLD}Extens√£o:${NC}  http://$DOMAIN/extension/corpmonitor.crx"
echo -e "   ${BOLD}Update:${NC}    http://$DOMAIN/extension/update.xml"
echo ""

if [ -n "$EXTENSION_ID" ]; then
    echo -e "${CYAN}üîë Extension ID:${NC} ${BOLD}$EXTENSION_ID${NC}"
fi
echo -e "${CYAN}üîê SHA256:${NC}       ${BOLD}${SHA256_HASH:0:32}...${NC}"
echo ""

echo -e "${CYAN}üìÑ Relat√≥rio completo:${NC} $REPORT_FILE"
echo -e "${CYAN}üìÇ Backup:${NC}             $BACKUP_FILE"
echo -e "${CYAN}üìú Log:${NC}                $LOG_FILE"
echo ""

echo -e "${YELLOW}üéØ Pr√≥ximos Passos:${NC}"
echo -e "   ${GREEN}1.${NC} Atualizar Registry.wxs com Extension ID"
echo -e "   ${GREEN}2.${NC} Recompilar MSI: ${BOLD}.\\build-msi.ps1${NC}"
echo -e "   ${GREEN}3.${NC} Testar instala√ß√£o via GPO"
echo ""

echo -e "${GREEN}‚úì Deploy completo em $(date)${NC}"
